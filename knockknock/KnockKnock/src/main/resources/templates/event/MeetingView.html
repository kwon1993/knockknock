<!DOCTYPE html>
<html xmlns:layout="http://www.w3.org/1999/xhtml" 
layout:decorate="~{etc/fragments/Main_layout}">
<head>
<meta charset="UTF-8">
<title th:text="${MeetingView.title}"></title>
<style type="text/css">

body{
	font-family: 'Jua', sans-serif;
}

#jumbotronId{
    background-color: white;
}
/* The Modal (background) */
.modal {
	display: none; /* Hidden by default */
	position: fixed; /* Stay in place */
	z-index: 3; /* Sit on top */
	padding-top: 100px; /* Location of the box */
	left: 0;
	top: 0;
	width: 100%; /* Full width */
	height: 100%; /* Full height */
	overflow: auto; /* Enable scroll if needed */
	background-color: rgb(0, 0, 0); /* Fallback color */
	background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
	background-color: #fefefe;
	margin: auto;
	padding: 30px;
	border: 1px solid #888;
	width: 30%;
	border-top-width: 0px;
}
</style>
</head>
<body>
	<div layout:fragment="content" class="container">
		<div class="jumbotron" id="jumbotronId">
			<h3>모임 게시판</h3>
			<div class="row">
				<div class="col-2">
					<img class="d-block" width="150" height="150" id="foo" src="#" onerror="this.src='/images/meeting/default.png';"/>
					<h6>개설자 정보</h6>
					<span th:text="${MeetingView.nickname}"></span>
				</div>
			<div class="col">
			<h1 th:text="${MeetingView.title}">제목</h1>
<!-- 			<span th:text="${MeetingView.nickname} + ' | '">닉네임</span> -->
			<span th:text="'작성일 : '+${MeetingView.writeTime} + ' | '">작성일</span>
			<span th:text="'조회수 : ' + ${MeetingView.hit}"></span>
				<form>
					<div>
						<br/>
						<span th:text="모임소개"></span>
						<p th:text="${MeetingView.detailIntroduce}"></p>
					</div>
					<div>
						<span>모임정보</span>
						<ul>
							<li th:text="'모임 테마 : '+ ${MeetingView.favorite}"></li>
							<li th:text="'성별 : '+ ${MeetingView.gender}"></li>
							<li th:text="'모임 기간 : '+
							${#dates.format(MeetingView.meetingStartTime, 'yyyy-MM-dd HH:mm')} + ' ~ ' +
							${#dates.format(MeetingView.meetingEndTime, 'yyyy-MM-dd HH:mm')}"></li>						
							<li th:text="'접수 기간 : '+
							${#dates.format(MeetingView.acceptStartTime, 'yyyy-MM-dd HH:mm')} + ' ~ ' +
							${#dates.format(MeetingView.acceptEndTime, 'yyyy-MM-dd HH:mm')}"></li>
							<li th:text="'모집 인원 : '+${MeetingView.recruitNumber}+'/'+${MeetingView.recruitMaxNumber}+'명'"></li>
						</ul>
					</div>
				</form>
			</div>
		</div>
		<button class="btn btn-success" id="myBtn" th:text="'참가하기'"></button>
		<!-- 참가하기 모달창 (로그인시에만 참가하기 구현필요, 인원이 만석되면 참가불가 구현필요)-->
<!-- 			
			  Modal1
				  <div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				    <div class="modal-dialog modal-sm" role="document">
				    
				      Modal content
				      <div class="modal-content">
				        <div class="modal-header">
				          <h5 class="modal-title" id="myModalLable" th:text="'모임에 참가하시겠습니까?'"></h5>
				          <button type="button" class="close" data-dismiss="modal" th:text="'x'"></button>
				        </div>
						<div class="modal-body">
							<form id="goform" action="/mparticipate">
								회원번호:<input type="number" name="memberNumber">					
								<input type="hidden" name="writingNumber" th:value="${MeetingView.writingNumber}">
							</form>
								<button type="submit" class="btn btn-success" id="signin" form="goform" th:text="'참가'"></button>
								<button type="button" class="btn btn-default" data-dismiss="modal" th:text="'취소'"></button>
						</div>
					  </div>
					  
				    </div>
				  </div>
				  
				  Modal2
				  <div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				    <div class="modal-dialog modal-sm" role="document">
				    
				      Modal content
				      <div class="modal-content">
				        <div class="modal-header">
				          <h4 class="modal-title" id="myModalLable" th:text="'참여 완료되었습니다.'"></h4>
				          <button type="button" class="close" data-dismiss="modal" th:text="'x'"></button>
				        </div>
				        <div class="modal-body">
				          <a class="btn btn-success" th:href="@{/#}" th:text="'신청내역보기'"></a>
				        </div>
				        <div class="modal-footer">
				          <a class="btn btn-default pull-rigth" data-dismiss="modal" id="something" th:text="'확인'"></a>
				        </div>
				      </div>
				      
				    </div>
				  </div> -->
				  <div id="myModal" class="modal">
					<div class="modal-content">
						<form action="/mparticipate" method="post" id="mparticipateForm" >
							<div class="modal-header">
								<span class="close">&times;</span>
							</div>
							<div class="modal-body">
								<h5 class="modal-title" id="myModalLable" th:text="'모임에 참가하시겠습니까?'"></h5>
								<p th:text="'닉네임: '+${session.nickname}"></p>
								<input type="text" name="writingNumber" th:value="${MeetingView.writingNumber}">
								<input type="text" name="memberNumber" th:value="${session.memberNumber}">
							</div>
							<div class="modal-footer">
									<button type="button" class="btn btn-success" id="mparticipate" data-dismiss="modal" th:text="'참가'"></button>
									<button type="button" class="btn btn-default" id="closeModal" th:text="취소"></button>
									<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"> 
							</div>
						</form>
					</div>
				</div>
			
			<!-- from 성현 -->
			<!-- 세션으로 가져온 닉네임과 글쓴 사람이 맞으면 수정,삭제 활성화 -->
			<span th:if="${session.nickname}==${MeetingView.nickname}">
				<a class="btn" role="button" th:href="@{/meetingModifyForm(writingNumber=${MeetingView.writingNumber})}" th:text="'수정'"></a>
				<a class="btn btn-danger pull-right" role="button" th:href="@{/meetingDelete(writingNumber=${MeetingView.writingNumber})}" th:text="'삭제'"></a>
			</span>
			<a class="btn" role="button" th:href="@{/meetingList}" th:text="'목록'"></a>
			
			
			<!-- <a class="btn" role="button" th:href="@{/meetingModifyForm(writingNumber=${MeetingView.writingNumber})}" th:text="'수정'"></a>
			<a class="btn" role="button" th:href="@{/meetingList}" th:text="'목록'"></a>
			<a class="btn btn-danger pull-right" role="button" th:href="@{/meetingDelete(writingNumber=${MeetingView.writingNumber})}" th:text="'삭제'"></a> -->
		</div>
<script>
// var formId = '<?=$MeetingView.detailIntroduce?>';
// $.get("appr-form/form_"+formId+".html").done(function (data) {
// 	CKEDITOR.instances["approval_content"].setData(data);
// });

//모달 생성
/* $(document).ready(function(){
	$("#signin").on("click", function(){
	 	$('#myModal1').modal('hide');
	});
	$("#signin").on("click", function(){
		$('#myModal2').modal('show');
	});
	$('#something').click(function() {
	    location.reload();
	});
}); */
</script>
<!-- 참가하기 모달 -->
<script>
	<!-- 시큐리티 + 에이젝스 에러 방지 설정222 -->
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	$(function() {
		$(document).ajaxSend(function(e, xhr, options) {
			xhr.setRequestHeader(header, token);
		});
	});
	//from 성현 :로그인한 사람의 닉네임 가져오기
	var nick =$("#sessionNickname").val();
	
	// Get the modal
	var modal = document.getElementById('myModal');

	// Get the button that opens the modal
	var btn = document.getElementById("myBtn");

	// Get the <span> element that closes the modal
	var span = document.getElementsByClassName("close")[0];
	
	var closeModal = document.getElementById("closeModal");
	var mparticipate = document.getElementById("mparticipate");
	
	// When the user clicks the button, open the modal 
	btn.onclick = function() {
		//from 성현 : 시큐리티 적용(세션닉이 없을 때 action을 로긴으로 바꾼 후 서브밋)
		if(nick==""){
			alert('먼저 로그인을 해주세요');
			var	form =$("#mparticipateForm");
			form.action = "/login";
			form.submit();
			return false;
		}
		modal.style.display = "block";
	}

	// When the user clicks on <span> (x), close the modal
	span.onclick = function() {
		modal.style.display = "none";
	}

	// When the user clicks anywhere outside of the modal, close it
	window.onclick = function(event) {
		if (event.target == modal) {
			modal.style.display = "none";
		}
	}

	closeModal.onclick = function(){
		modal.style.display = "none";
	}
	
	mparticipate.onclick = function(){
			
		writingNumber= $("input[name='writingNumber']").val();
		memberNumber= $("input[name='memberNumber']").val();
		// var ss = $("#visitBookingForm").serialize();
		 inner ="";
		
		$.ajax({
			method:'post',
			url: '/mparticipate',
			data:
				JSON.stringify({ // form에서 받아온 값들을 json 형식의 데이터로 처리
				"writingNumber":writingNumber,
				"memberNumber":memberNumber
			}),
			dataType: "text", // 리턴 타입이 void일 경우에는 "json"이 아니라 "text"로
			contentType:"application/json", // 정확한 이유는 모르겠으나 이거 없으면 415 에러 발생
			success:function(data){
				inner+="<div class='modal-content'><span id='modalx' class='close'>&times;</span><br /><h4>모임참여신청이 완료되었습니다</h4><br /><a class='btn btn-default pull-rigth' href='/profileMain'>신청확인하기</a><br /></div>"

				$("#myModal").html(inner);
			}/* ,
			error:function(data){  
				inner+="<div class='modal-content'><span id='modalx' class='close'>&times;</span><br /><h4>에러 발생</h4><br /></div>"
				$("#myModal").html(inner);
			} */
		});
	};
	
	// 동적으로 생성된 태그에 이벤트 걸기
	$(document).on("click", "#modalx", function(){
		modal.style.display = "none";
	});
</script>
</div>
</body>
</html>